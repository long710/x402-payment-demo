x402 æµç¨‹æ­¥éª¤ä¸ä»£ç å¯¹ç…§è¡¨

================================================================================
æ­¥éª¤ 1ï¼šå®¢æˆ·ç«¯é¦–æ¬¡è¯·æ±‚
================================================================================

ã€ä½ç½®ã€‘client.ts ç¬¬ 23-26 è¡Œ

ã€ä»£ç ã€‘
console.log("1. å°è¯•è·å–ä»·æ ¼...");
const initialRes = await axios.get(url);
console.log("âœ… æ„å¤–æˆåŠŸï¼ˆå·²æœ‰æ”¶æ®ï¼‰:", initialRes.data.price);

ã€è¯´æ˜ã€‘
å®¢æˆ·ç«¯ç›´æ¥è¯·æ±‚ APIï¼Œä¸å¸¦ä»»ä½•è®¤è¯ä¿¡æ¯ã€‚ç”±äºæ²¡æœ‰æ”¶æ®ï¼ŒæœåŠ¡ç«¯ä¼šè¿”å› 402 é”™è¯¯ã€‚

================================================================================
æ­¥éª¤ 1ï¼ˆæœåŠ¡ç«¯å“åº”ï¼‰ï¼šè¿”å› 402 + nonce
================================================================================

ã€ä½ç½®ã€‘server.ts ç¬¬ 70-78 è¡Œ

ã€ä»£ç ã€‘
const serverNonce = `x402_${Math.random().toString(36).substring(7)}`;
pendingNonces.set(serverNonce, eventId);
return c.json({
    error: "402 Payment Required",
    amount: "10 Tokens",
    destination: ORACLE_WALLET,
    nonce: serverNonce
}, 402);

ã€è¯´æ˜ã€‘
æœåŠ¡ç«¯æ£€æµ‹åˆ°æ— è®¤è¯ä¿¡æ¯ï¼Œç”Ÿæˆå”¯ä¸€ nonceï¼Œè¿”å› 402 çŠ¶æ€ç å’Œæ”¯ä»˜æŒ‡ä»¤ã€‚

================================================================================
æ­¥éª¤ 2ï¼šå®¢æˆ·ç«¯æ•è· 402ï¼Œæ£€æŸ¥ä½™é¢
================================================================================

ã€ä½ç½®ã€‘client.ts ç¬¬ 27-56 è¡Œ

ã€ä»£ç ã€‘
if (error.response?.status === 402) {
    console.warn(`\n[402] æ•è·åˆ°æ”¯ä»˜è¯·æ±‚ã€‚å¼€å§‹å‡†å¤‡ BSC é“¾ä¸Šæ”¯ä»˜...`);

    const [decimals, balance, bnbBalance] = await Promise.all([
        tokenContract.decimals(),
        tokenContract.balanceOf(wallet.address),
        provider.getBalance(wallet.address)
    ]);

    const { nonce, destination, amount: requiredAmountStr } = error.response.data;
    const payAmount = ethers.parseUnits("10", decimals);

    console.log(`ğŸ”¹ è´¦æˆ·åœ°å€: ${wallet.address}`);
    console.log(`ğŸ”¹ ä»£å¸ä½™é¢: ${ethers.formatUnits(balance, decimals)}`);
    console.log(`ğŸ”¹ BNB ä½™é¢ : ${ethers.formatEther(bnbBalance)}`);

    if (balance < payAmount) {
        console.error("âŒ é”™è¯¯: ä»£å¸ä½™é¢ä¸è¶³ä»¥æ”¯ä»˜ 10 ä¸ªå•ä½ã€‚è¯·å……å€¼åå†è¯•ã€‚");
        return;
    }
    if (bnbBalance < ethers.parseEther("0.0005")) {
        console.error("âŒ é”™è¯¯: BNB ä½™é¢ä¸è¶³ä»¥æ”¯ä»˜ Gas è´¹ã€‚");
        return;
    }
}

ã€è¯´æ˜ã€‘
å®¢æˆ·ç«¯æ•è· 402 å“åº”ï¼Œä»ä¸­æå– nonceã€destinationã€amountã€‚
å¹¶è¡ŒæŸ¥è¯¢ä»£å¸ä½™é¢å’Œ BNB ä½™é¢ï¼Œæ£€æŸ¥æ˜¯å¦è¶³å¤Ÿæ”¯ä»˜ã€‚

================================================================================
æ­¥éª¤ 3ï¼šå®¢æˆ·ç«¯æ„é€ äº¤æ˜“å¹¶å‘é€ï¼ˆé“¾ä¸Šæ”¯ä»˜ï¼‰
================================================================================

ã€ä½ç½®ã€‘client.ts ç¬¬ 58-74 è¡Œ

ã€ä»£ç ã€‘
console.log(`2. æ‰§è¡Œæ”¯ä»˜ä¸­... Nonce: ${nonce}`);

// å°† nonce è½¬ä¸ºåå…­è¿›åˆ¶
const nonceHex = ethers.hexlify(ethers.toUtf8Bytes(nonce));

// ç¼–ç  ERC-20 transfer å‡½æ•°è°ƒç”¨
const baseData = tokenContract.interface.encodeFunctionData("transfer", [destination, payAmount]);

// ã€æ ¸å¿ƒã€‘å°† nonce é™„åŠ åˆ° calldata æœ«å°¾
const txData = ethers.concat([baseData, nonceHex]);

// å‘é€äº¤æ˜“
const tx = await wallet.sendTransaction({
    to: TOKEN_ADDRESS,
    data: txData,
    gasLimit: 100000
});

console.log(`âœ… æ”¯ä»˜å·²å‘é€ï¼å“ˆå¸Œ: ${tx.hash}`);

ã€è¯´æ˜ã€‘
è¿™æ˜¯ x402 çš„æ ¸å¿ƒæŠ€æœ¯ç‚¹ï¼š
1. å°† nonce å­—ç¬¦ä¸²è½¬ä¸ºåå…­è¿›åˆ¶
2. ç¼–ç æ ‡å‡†çš„ ERC-20 transfer è°ƒç”¨
3. å°† nonce æ‹¼æ¥åˆ° calldata æœ«å°¾ï¼ˆåˆçº¦ä¼šå¿½ç•¥ï¼Œä½†é“¾ä¸Šå¯æŸ¥ï¼‰
4. å‘é€äº¤æ˜“åˆ° BSC ç½‘ç»œ

================================================================================
æ­¥éª¤ 4ï¼šç­‰å¾… BSC ç¡®è®¤
================================================================================

ã€ä½ç½®ã€‘client.ts ç¬¬ 73-74 è¡Œ

ã€ä»£ç ã€‘
console.log("â³ ç­‰å¾… BSC ç¡®è®¤ä¸­...");
await tx.wait();

ã€è¯´æ˜ã€‘
tx.wait() ä¼šé˜»å¡ç›´åˆ°äº¤æ˜“è¢«æ‰“åŒ…è¿›åŒºå—ã€‚BSC å‡ºå—æ—¶é—´çº¦ 3 ç§’ã€‚

================================================================================
æ­¥éª¤ 5ï¼šå®¢æˆ·ç«¯æäº¤æ”¯ä»˜è¯æ˜
================================================================================

ã€ä½ç½®ã€‘client.ts ç¬¬ 76-80 è¡Œ

ã€ä»£ç ã€‘
console.log("3. æäº¤è¯æ˜å¹¶è·å–ç»“æœ...");
const finalRes = await axios.get(url, {
    headers: {
        'x-402-payment-proof': tx.hash,
        'x-402-nonce': nonce
    }
});

ã€è¯´æ˜ã€‘
å®¢æˆ·ç«¯æºå¸¦äº¤æ˜“å“ˆå¸Œå’ŒåŸå§‹ nonce é‡æ–°è¯·æ±‚ APIã€‚

================================================================================
æ­¥éª¤ 5ï¼ˆæœåŠ¡ç«¯å¤„ç†ï¼‰ï¼šé“¾ä¸ŠéªŒè¯
================================================================================

ã€ä½ç½®ã€‘server.ts ç¬¬ 59-68 è¡Œï¼ˆè·¯ç”±å¤„ç†ï¼‰+ ç¬¬ 20-45 è¡Œï¼ˆéªŒè¯å‡½æ•°ï¼‰

ã€è·¯ç”±ä»£ç ã€‘
const txHash = c.req.header('x-402-payment-proof');
const nonce = c.req.header('x-402-nonce');
if (txHash && nonce) {
    if (await verifyTokenPayment(txHash, nonce)) {
        // éªŒè¯é€šè¿‡ï¼Œç­¾å‘æ”¶æ®
        const receipt = await sign({ eventId, exp: Math.floor(Date.now()/1000) + 3600 }, SECRET_KEY);
        return c.json({ price: "98000.5", receipt });
    }
    return c.json({ error: "Payment verification failed" }, 403);
}

ã€éªŒè¯å‡½æ•°ä»£ç ã€‘
async function verifyTokenPayment(txHash: string, expectedNonce: string) {
    // 1. è·å–é“¾ä¸Šäº¤æ˜“æ•°æ®
    const tx = await provider.getTransaction(txHash);
    const receipt = await provider.getTransactionReceipt(txHash);
    if (!tx || !receipt || receipt.status !== 1) return false;

    // 2. éªŒè¯ç›®æ ‡åˆçº¦åœ°å€
    if (tx.to?.toLowerCase() !== TOKEN_ADDRESS.toLowerCase()) return false;

    // 3. éªŒè¯ nonce åœ¨äº¤æ˜“æ•°æ®ä¸­
    const nonceHex = ethers.hexlify(ethers.toUtf8Bytes(expectedNonce)).slice(2);
    if (!tx.data.includes(nonceHex)) return false;

    // 4. éªŒè¯ Transfer äº‹ä»¶çš„æ”¶æ¬¾åœ°å€
    const transferTopic = ethers.id("Transfer(address,address,uint256)");
    const log = receipt.logs.find(l => l.topics[0] === transferTopic);
    if (!log) return false;

    const recipient = ethers.getAddress(ethers.dataSlice(log.topics[2], 12));
    return recipient.toLowerCase() === ORACLE_WALLET.toLowerCase();
}

ã€è¯´æ˜ã€‘
æœåŠ¡ç«¯æ‰§è¡Œå››é‡éªŒè¯ï¼š
1. äº¤æ˜“å­˜åœ¨ä¸”æˆåŠŸï¼ˆstatus === 1ï¼‰
2. ç›®æ ‡æ˜¯æ­£ç¡®çš„ä»£å¸åˆçº¦
3. äº¤æ˜“ data ä¸­åŒ…å«æœåŠ¡ç«¯ç­¾å‘çš„ nonce
4. Transfer äº‹ä»¶çš„æ”¶æ¬¾åœ°å€æ˜¯ Oracle é’±åŒ…

================================================================================
æ­¥éª¤ 6ï¼šè¿”å›æ•°æ®
================================================================================

ã€ä½ç½®ã€‘server.ts ç¬¬ 64-65 è¡Œ

ã€ä»£ç ã€‘
const receipt = await sign({ eventId, exp: Math.floor(Date.now()/1000) + 3600 }, SECRET_KEY);
return c.json({ price: "98000.5", receipt });

ã€è¯´æ˜ã€‘
éªŒè¯é€šè¿‡åï¼ŒæœåŠ¡ç«¯è¿”å›ï¼š
1. price: è¯·æ±‚çš„æ•°æ®
2. receipt: JWT æ”¶æ®ï¼ˆæœ‰æ•ˆæœŸ 1 å°æ—¶ï¼‰

================================================================================
æ­¥éª¤ 7ï¼šå®¢æˆ·ç«¯æ”¶åˆ°æ”¶æ®
================================================================================

ã€ä½ç½®ã€‘client.ts ç¬¬ 81-82 è¡Œ

ã€ä»£ç ã€‘
console.log("\nğŸ‰ æœ€ç»ˆä»·æ ¼ç»“æœ:", finalRes.data.price);
console.log("ğŸ« æ”¶æ®:", finalRes.data.receipt.slice(0, 30) + "...");

ã€è¯´æ˜ã€‘
å®¢æˆ·ç«¯æˆåŠŸè·å–æ•°æ®å’Œ JWT æ”¶æ®ã€‚æ”¶æ®å¯ä¿å­˜ç”¨äºåç»­è¯·æ±‚ã€‚

================================================================================
ã€é™„åŠ ã€‘æ”¶æ®å¤ç”¨æµç¨‹
================================================================================

ã€ä½ç½®ã€‘server.ts ç¬¬ 50-57 è¡Œ

ã€ä»£ç ã€‘
const oldReceipt = c.req.header('x-402-receipt');
if (oldReceipt) {
    try {
        const payload = await verify(oldReceipt, SECRET_KEY);
        if (payload.eventId === eventId) {
            return c.json({ price: "98000.5", status: "Access via Receipt" });
        }
    } catch (e) {}
}

ã€è¯´æ˜ã€‘
å¦‚æœå®¢æˆ·ç«¯æºå¸¦æœ‰æ•ˆçš„ JWT æ”¶æ®ï¼ŒæœåŠ¡ç«¯ç›´æ¥è¿”å›æ•°æ®ï¼Œæ— éœ€å†æ¬¡éªŒè¯é“¾ä¸Šæ”¯ä»˜ã€‚
è¿™æ˜¯"å¿«é€Ÿé€šé“"ï¼Œé¿å…é‡å¤æ”¯ä»˜ã€‚

================================================================================
å®Œæ•´æµç¨‹å›¾ï¼ˆä»£ç è§†è§’ï¼‰
================================================================================

Client                                  Server                              BSC
  â”‚                                       â”‚                                  â”‚
  â”‚ axios.get(url)                        â”‚                                  â”‚
  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                  â”‚
  â”‚                                       â”‚ æ£€æŸ¥ headerï¼Œæ— è®¤è¯               â”‚
  â”‚                                       â”‚ ç”Ÿæˆ nonce                        â”‚
  â”‚                                       â”‚ return c.json({...}, 402)        â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                                  â”‚
  â”‚ 402 + {nonce, destination, amount}    â”‚                                  â”‚
  â”‚                                       â”‚                                  â”‚
  â”‚ tokenContract.decimals()              â”‚                                  â”‚
  â”‚ tokenContract.balanceOf()             â”‚                                  â”‚
  â”‚ provider.getBalance()                 â”‚                                  â”‚
  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚ ä½™é¢ä¿¡æ¯                               â”‚                                  â”‚
  â”‚                                       â”‚                                  â”‚
  â”‚ ethers.concat([baseData, nonceHex])   â”‚                                  â”‚
  â”‚ wallet.sendTransaction({data: txData})â”‚                                  â”‚
  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚ tx.hash                               â”‚                                  â”‚
  â”‚                                       â”‚                                  â”‚
  â”‚ tx.wait()                             â”‚                                  â”‚
  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚ äº¤æ˜“ç¡®è®¤                               â”‚                                  â”‚
  â”‚                                       â”‚                                  â”‚
  â”‚ axios.get(url, {headers: proof+nonce})â”‚                                  â”‚
  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                  â”‚
  â”‚                                       â”‚ provider.getTransaction(txHash)  â”‚
  â”‚                                       â”‚ provider.getTransactionReceipt() â”‚
  â”‚                                       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
  â”‚                                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                                       â”‚ éªŒè¯ 4 é¡¹æ£€æŸ¥                     â”‚
  â”‚                                       â”‚ sign({eventId, exp}, SECRET_KEY) â”‚
  â”‚                                       â”‚ return c.json({price, receipt})  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                                  â”‚
  â”‚ 200 + {price, receipt}                â”‚                                  â”‚
  â”‚                                       â”‚                                  â”‚
